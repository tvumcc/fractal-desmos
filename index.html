<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Fractal Desmos</title>
    <link rel="stylesheet" href="./style.css"/>
    <link rel="stylesheet" href="./lib/mathquill.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script type="module" src="./lib/mathquill.js"></script>
    <script type="module" src="./src/main.ts"></script>
    <script type="module">
    import { parse, state } from "./src/main.ts"

    let MQ = MathQuill.getInterface(2)
    let symbols = "alpha beta gamma delta epsilon zeta eta theta iota kappa lambda mu nu xi omikron pi rho sigma tau upsilon chi psi omega"
    let math_fields = document.getElementsByClassName("latex");
    for (let math_field of math_fields)
      MQ.StaticMath(math_field)

    let z0_entry = MQ.MathField(document.getElementById("z0"), {
      supSubsRequireOperand: true,
      autoCommands: "sqrt " + symbols,
      handlers: {
        edit: function() {
          parse(z0_entry.latex(), equation_entry.latex())
          let math_fields = document.getElementsByClassName("latex");
          for (let math_field of math_fields)
            MQ.StaticMath(math_field)
        }
      }
    })

    let equation_entry = MQ.MathField(document.getElementById("fz"), {
      supSubsRequireOperand: true,
      autoCommands: "sqrt " + symbols,
      handlers: {
        edit: function() {
          parse(z0_entry.latex(), equation_entry.latex())
          let math_fields = document.getElementsByClassName("latex");
          for (let math_field of math_fields)
            MQ.StaticMath(math_field)
        }
      }
    })

    class Preset {
      initial_value
      equation
      variables

      constructor(initial_value, equation, variables) {
        this.initial_value = initial_value;
        this.equation = equation;
        if (variables) {
          this.variables = variables;
        }
      }
    }

    let presets = new Map([
      ["time-julia-set", new Preset("x", "z^2+a\\left(\\cos\\left(t\\right)+i\\sin\\left(t\\right)\\right)", new Map([["a", [0.9, 0.0]]]))],
      ["mouse-julia-set", new Preset("ax", "z^2 + c", new Map([["a", [1.0, 0.0]]]))],
      ["star-julia", new Preset("x", "z^5 + a", new Map([["a", [0.765, 0.535]]]))],
      ["inverse-julia", new Preset("x", "\\frac{1}{z^2} + a", new Map([["a", [0.016, 0.535]]]))],
      ["mandelbrot-set", new Preset("0", "z^2 + x", new Map())],
      ["sine-mandelbrot", new Preset("0", "\\sin\\left(z^2+x\\right)", new Map())],
      ["moth", new Preset("x", "z^x+z^z", new Map())],
      ["web", new Preset("x^5", "\\frac{1}{4}\\sin\\left(z^2+\\ln\\left(z\\right)+\\cos\\left(2t\\right)+i\\sin\\left(2t\\right)\\right)", new Map())]
    ])

    let preset_div = document.getElementById("presets")
    for (let button of preset_div.children) {
      button.addEventListener("click", () => set_preset(button.id))
    }

    function set_preset(preset_str) {
        if (presets.has(preset_str)) {
            let preset = presets.get(preset_str)

            parse(preset.initial_value, preset.equation)
            z0_entry.latex(preset.initial_value)
            equation_entry.latex(preset.equation)

            if (preset.variables) {
                for (let [k, v] of preset.variables) {
                    if (state.variables.has(k)) {
                        state.variables.get(k).real = v[0]
                        state.variables.get(k).imag = v[1]
                        state.update_var_sliders()
                    }
                }
            }
        }
    }

    </script>
  </head>
  <body>
    <div class="main-container">
      <div class="side-panel">
        <div class="title">
          <h1>Fractal Desmos</h1>
          <p><a href="https://github.com/tvumcc/fractal-desmos" target="_blank"><img width="30" height="30" src="./assets/github.png"></a></p>
        </div>
        <div id="info">
          <h2>How To Use</h2>
          <div id="how-to-use">
            <p>
              Enter in your own equations for an 
              <a href="https://en.wikipedia.org/wiki/Plotting_algorithms_for_the_Mandelbrot_set#Escape_time_algorithm">escape time fractal</a>
              or choose from the presets
              to get some ideas. 
            </p>
            <p><b>z<sub>0</sub></b> is initial value of <b>z</b>, and <b>f(z)</b>
              is function of <b>z</b> applied on each iteration to get the next value of <b>z</b>.
            </p>
            <p>
              Variables you add in the equations that aren't predefined parameters (listed below)
              will appear as sliders.              
            </p>
          </div>
          <h2>Controls</h2>
          <div id="controls">
            <p>Use these in the fractal viewport:</p>
            <p><b>Left Click</b> and drag to pan</p>
            <p><b>Right Click</b> and drag to set the value of <b>c</b></p>
            <p><b>Scroll</b> to zoom in or out on a location</p>
          </div>
          <h2>Parameters</h2>
          <div id="parameters">
            <p>Use these as variables in your equations:</p>
            <p><b>z</b> iteration variable</p>
            <p><b>i</b> the square root of -1</p>
            <p><b>x</b> pixel coordinate</p>
            <p><b>t</b> current time (imaginary part = 0)</p>
            <p><b>c</b> mouse coordinates</p>
          </div>
          <h2>Presets</h2>
          <div id="presets">
            <button class="preset-button" id="time-julia-set">Time Julia Set</button>
            <button class="preset-button" id="mouse-julia-set">Mouse Julia Set</button>
            <button class="preset-button" id="star-julia">Star Julia</button>
            <button class="preset-button" id="inverse-julia">Inverse Julia</button>
            <button class="preset-button" id="mandelbrot-set">Mandelbrot Set</button>
            <button class="preset-button" id="sine-mandelbrot">Sine Mandelbrot</button>
            <button class="preset-button" id="moth">Moth</button>
            <button class="preset-button" id="web">Web</button>
          </div>

          <hr>
          <div class="entry">
            <p class="equation-indicator">
              <span class="latex">z_0</span>
            </p>
            <p class="equals">=</p>
            <p class="formula-entry">
              <span id="z0">x+a</span>
            </p>
          </div>
          <div class="entry">
            <p class="equation-indicator">
              <span class="latex">f(z)</span>
            </p>
            <p class="equals">=</p>
            <p class="formula-entry">
              <span id="fz">z^2+\cos\left(t\right)+i\sin\left(t\right)</span>
            </p>
          </div>
        </div>

        <div id="var-sliders"></div>
      </div>

      <div class="fractal-canvas">
        <canvas id="webgpu-canvas"></canvas>
      </div>
    </div>
  </body>
</html>